<!DOCTYPE html>
<html>
<head>
    <title>네이버 검색광고 광고 리포트</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap">
    <style>
        /* 전체 스타일 */
        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }

        /* 헤더 스타일 */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #03C75A;
            margin-bottom: 10px;
        }

        .header p {
            color: #555;
            font-size: 16px;
        }

        /* 네비게이션 바 */
        .navbar {
            background-color: #03C75A;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
            margin-bottom: 30px;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 20px;
        }

        .nav-logo a {
            color: white;
            font-weight: 700;
            font-size: 20px;
            text-decoration: none;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-item {
            position: relative;
            margin: 0 10px;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: white;
            border-radius: 1.5px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 5px 10px;
            transition: opacity 0.3s;
        }

        .nav-link:hover {
            opacity: 0.8;
        }

        /* 리포트 컨테이너 */
        .report-container {
            width: 100%;
            margin: 20px auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* 필터 섹션 */
        .filter-section {
            border-bottom: 1px solid #eee;
            background-color: #f9f9f9;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
        }

        .filter-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        .filter-header h2 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .filter-content {
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .select-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        /* 리포트 버튼 */
        .report-btn {
            background-color: #03c75a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            font-weight: 500;
        }

        .report-btn:hover {
            background-color: #02a64b;
        }

        /* 리포트 섹션 */
        .report-section {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 요약 카드 스타일 */
        .report-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .summary-title {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 20px;
            font-weight: 700;
            color: #03C75A;
        }

        /* 차트 컨테이너 */
        .chart-container {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
            background-color: white;
            border-radius: 10px;
        }

        /* 테이블 스타일 */
        .table-container {
            overflow-x: auto;
        }

        .table-container h3 {
            margin-top: 0;
            font-size: 16px;
            color: #333;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .report-table th {
            background-color: #f2f2f2;
            padding: 10px 15px;
            text-align: left;
            font-weight: 500;
            color: #333;
        }

        .report-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        .report-table tr:hover {
            background-color: #f9f9f9;
        }

        .empty-data {
            text-align: center;
            padding: 20px;
            color: #888;
            font-style: italic;
        }

        /* 다중 선택 박스 스타일 */
        .select-box[multiple] {
            height: 120px !important;
            padding: 5px !important;
            overflow-y: auto !important;
        }
        
        .select-box[multiple] option {
            padding: 5px !important;
            margin-bottom: 2px !important;
            border-radius: 3px !important;
            cursor: pointer !important;
        }
        
        .select-box[multiple] option:checked {
            background-color: #03C75A !important;
            color: white !important;
        }
        
        /* 선택된 항목 표시 영역 */
        .selected-items {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            display: none;
        }
        
        .selected-items h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }
        
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .selected-tag {
            background-color: #03C75A;
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
        }
        
        .selected-tag .remove-tag {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .selected-tag .remove-tag:hover {
            color: #ff5252;
        }
        
        /* 반응형 스타일 */
        @media (max-width: 768px) {
            .report-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .select-box[multiple] {
                height: 100px;
            }
            
            .nav-container {
                flex-direction: column;
                align-items: center;
            }
            
            .nav-logo {
                margin-bottom: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .report-summary {
                grid-template-columns: 1fr;
            }
            
            .report-table {
                font-size: 12px;
            }
            
            .report-table th, .report-table td {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- 네비게이션 바 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="/">네이버 검색광고 관리</a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/" class="nav-link">키워드 관리 챗봇</a>
                </li>
                <li class="nav-item active">
                    <a href="/report" class="nav-link">광고 리포트</a>
                </li>
            </ul>
        </div>
    </nav>
    
    <div class="header">
        <h1>네이버 검색광고 리포트</h1>
        <p>네이버 검색광고 API를 활용한 광고 성과 및 통계 분석 리포트입니다.</p>
    </div>
    
    <div class="report-container">
        <!-- 필터 섹션 -->
        <div class="filter-section">
            <div class="filter-header">
                <h2>리포트 필터</h2>
            </div>
            <div class="filter-content">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="date-range">기간 선택</label>
                        <select id="date-range" class="select-box">
                            <option value="today">오늘</option>
                            <option value="yesterday">어제</option>
                            <option value="7days" selected>최근 7일</option>
                            <option value="30days">최근 30일</option>
                            <option value="custom">사용자 지정</option>
                        </select>
                    </div>
                    
                    <div class="filter-group" id="custom-date-container" style="display: none;">
                        <label for="start-date">시작일</label>
                        <input type="date" id="start-date" class="date-input">
                        <label for="end-date">종료일</label>
                        <input type="date" id="end-date" class="date-input">
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="campaign-filter">캠페인</label>
                        <select id="campaign-filter" class="select-box" multiple size="5">
                            <option value="" selected>캠페인 선택</option>
                        </select>
                        <div class="selected-items" id="selected-campaigns">
                            <h4>선택된 캠페인</h4>
                            <div class="selected-tags" id="campaign-tags"></div>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label for="adgroup-filter">광고그룹</label>
                        <select id="adgroup-filter" class="select-box" multiple size="5">
                            <option value="" selected>광고그룹 선택</option>
                            <option value="">전체 광고그룹</option>
                        </select>
                        <div class="selected-items" id="selected-adgroups">
                            <h4>선택된 광고그룹</h4>
                            <div class="selected-tags" id="adgroup-tags"></div>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label for="keyword-filter">키워드</label>
                        <select id="keyword-filter" class="select-box" multiple size="5">
                            <option value="" selected>키워드 선택</option>
                            <option value="">전체 키워드</option>
                        </select>
                        <div class="selected-items" id="selected-keywords">
                            <h4>선택된 키워드</h4>
                            <div class="selected-tags" id="keyword-tags"></div>
                        </div>
                    </div>
                </div>
                
                <button id="generate-report-btn" class="report-btn">리포트 생성</button>
            </div>
        </div>
        
        <!-- 차트 및 요약 섹션 -->
        <div class="report-section">
            <div class="report-summary">
                <div class="summary-card">
                    <div class="summary-title">총 비용</div>
                    <div class="summary-value" id="total-cost">-</div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-title">총 노출수</div>
                    <div class="summary-value" id="total-impressions">-</div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-title">총 클릭수</div>
                    <div class="summary-value" id="total-clicks">-</div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-title">평균 CPC</div>
                    <div class="summary-value" id="average-cpc">-</div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-title">CTR</div>
                    <div class="summary-value" id="average-ctr">-</div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-title">평균 노출순위</div>
                    <div class="summary-value" id="average-rank">-</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="performance-chart"></canvas>
            </div>
            
            <div class="table-container">
                <h3>상세 데이터</h3>
                <table id="report-table" class="report-table">
                    <thead>
                        <tr>
                            <th>날짜</th>
                            <th>비용</th>
                            <th>노출수</th>
                            <th>클릭수</th>
                            <th>CTR</th>
                            <th>평균 CPC</th>
                            <th>평균 노출순위</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="empty-data">리포트를 생성하려면 '리포트 생성' 버튼을 클릭하세요.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 다중 선택 기능 설정
            enableMultipleSelection('campaign-filter');
            enableMultipleSelection('adgroup-filter');
            enableMultipleSelection('keyword-filter');
            
            // 다중 선택 기능 활성화 함수
            function enableMultipleSelection(elementId) {
                const selectElement = document.getElementById(elementId);
                
                // Ctrl 키를 누르지 않고도 다중 선택이 가능하도록 설정
                selectElement.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    
                    const option = e.target;
                    if (option.tagName.toLowerCase() !== 'option') return;
                    
                    // 기본 옵션(placeholder)은 다중 선택에서 제외
                    if (option.value === '' && option === this.options[0]) {
                        this.selectedIndex = -1;  // 모든 선택 해제
                        return;
                    }
                    
                    // 옵션의 selected 상태 토글
                    option.selected = !option.selected;
                    
                    // 선택된 옵션이 있는지 확인
                    const hasSelectedOptions = Array.from(this.options).some(opt => opt.selected && opt.value !== '');
                    
                    // 첫 번째 옵션(placeholder)의 선택 상태 관리
                    if (this.options[0].value === '') {
                        this.options[0].selected = !hasSelectedOptions;
                    }
                    
                    // 변경 이벤트 발생
                    const event = new Event('change');
                    this.dispatchEvent(event);
                });
            }
            
            const dateRangeSelect = document.getElementById('date-range');
            const customDateContainer = document.getElementById('custom-date-container');
            const generateReportBtn = document.getElementById('generate-report-btn');
            const campaignFilterSelect = document.getElementById('campaign-filter');
            const adgroupFilterSelect = document.getElementById('adgroup-filter');
            const keywordFilterSelect = document.getElementById('keyword-filter');
            
            // 선택된 항목 표시 영역
            const selectedCampaigns = document.getElementById('selected-campaigns');
            const selectedAdgroups = document.getElementById('selected-adgroups');
            const selectedKeywords = document.getElementById('selected-keywords');
            const campaignTags = document.getElementById('campaign-tags');
            const adgroupTags = document.getElementById('adgroup-tags');
            const keywordTags = document.getElementById('keyword-tags');
            
            // 선택된 항목 저장 배열
            let selectedCampaignItems = [];
            let selectedAdgroupItems = [];
            let selectedKeywordItems = [];
            
            // 날짜 기본값 설정
            const today = new Date();
            const startDate = document.getElementById('start-date');
            const endDate = document.getElementById('end-date');
            
            // 오늘 날짜 설정
            endDate.valueAsDate = today;
            
            // 7일 전 날짜 설정
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            startDate.valueAsDate = sevenDaysAgo;
            
            // 기간 선택 이벤트
            dateRangeSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customDateContainer.style.display = 'block';
                } else {
                    customDateContainer.style.display = 'none';
                    
                    // 선택한 기간에 따라 날짜 설정
                    const today = new Date();
                    endDate.valueAsDate = today;
                    
                    let startDay = new Date(today);
                    if (this.value === 'today') {
                        startDay = new Date(today);
                    } else if (this.value === 'yesterday') {
                        startDay.setDate(today.getDate() - 1);
                        endDate.valueAsDate = startDay;
                    } else if (this.value === '7days') {
                        startDay.setDate(today.getDate() - 7);
                    } else if (this.value === '30days') {
                        startDay.setDate(today.getDate() - 30);
                    }
                    
                    startDate.valueAsDate = startDay;
                }
            });
            
            // Select 요소 초기화 함수
            function resetSelect(selectElement, defaultLabel) {
                // 현재 선택된 항목 저장
                const selectedValues = Array.from(selectElement.selectedOptions)
                    .filter(option => option.value !== '')
                    .map(option => {
                        return {
                            value: option.value,
                            text: option.textContent
                        };
                    });
                
                selectElement.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = defaultLabel;
                defaultOption.selected = selectedValues.length === 0;
                selectElement.appendChild(defaultOption);
                
                return selectedValues;
            }
            
            // 캠페인 목록 불러오기
            async function loadCampaigns() {
                try {
                    const response = await fetch('/api/campaigns');
                    
                    if (response.ok) {
                        const data = await response.json();
                        const campaigns = data.campaigns;
                        
                        // 현재 선택된 캠페인 ID 저장
                        const selectedOptions = Array.from(campaignFilterSelect.selectedOptions)
                            .filter(option => option.value !== '')
                            .map(option => {
                                return {
                                    value: option.value,
                                    text: option.textContent
                                };
                            });
                        
                        // 캠페인 필터 옵션 초기화
                        campaignFilterSelect.innerHTML = '';
                        
                        // 기본 옵션 추가
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = '캠페인 선택';
                        campaignFilterSelect.appendChild(defaultOption);
                        
                        // 캠페인 필터 옵션 추가
                        campaigns.forEach(campaign => {
                            const option = document.createElement('option');
                            option.value = campaign.nccCampaignId;
                            option.textContent = campaign.name || campaign.nccCampaignId;
                            
                            // 이전에 선택된 값이면 선택 상태로 설정
                            if (selectedOptions.some(item => item.value === campaign.nccCampaignId)) {
                                option.selected = true;
                            }
                            
                            campaignFilterSelect.appendChild(option);
                        });
                        
                        // 선택된 항목이 있으면 관련 데이터 로드
                        const selectedCampaignIds = selectedOptions.map(opt => opt.value);
                        if (selectedCampaignIds.length > 0) {
                            updateSelectedItems('campaign', selectedCampaignIds);
                            loadAdgroups(selectedCampaignIds);
                        }
                    } else {
                        console.error('캠페인 정보를 불러오는데 실패했습니다.');
                        showErrorAlert('캠페인 정보를 불러오는데 실패했습니다.');
                    }
                } catch (error) {
                    console.error('캠페인 정보를 불러오는데 실패했습니다:', error);
                    showErrorAlert('캠페인 정보를 불러오는데 실패했습니다.');
                }
            }
            
            // 광고그룹 목록 불러오기
            async function loadAdgroups(campaignIds) {
                try {
                    if (!campaignIds || campaignIds.length === 0) {
                        // 캠페인이 선택되지 않은 경우 광고그룹 초기화
                        adgroupFilterSelect.innerHTML = '';
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = '광고그룹 선택';
                        adgroupFilterSelect.appendChild(defaultOption);
                        
                        // 키워드도 초기화
                        keywordFilterSelect.innerHTML = '';
                        const defaultKeywordOption = document.createElement('option');
                        defaultKeywordOption.value = '';
                        defaultKeywordOption.textContent = '키워드 선택';
                        keywordFilterSelect.appendChild(defaultKeywordOption);
                        
                        return;
                    }
                    
                    // 현재 선택된 광고그룹 ID 저장
                    const selectedOptions = Array.from(adgroupFilterSelect.selectedOptions)
                        .filter(option => option.value !== '')
                        .map(option => {
                            return {
                                value: option.value,
                                text: option.textContent,
                                campaignId: option.dataset.campaignId
                            };
                        });
                    
                    // 선택된 캠페인에 속하지 않는 광고그룹은 제외
                    const validSelectedOptions = selectedOptions.filter(opt => 
                        campaignIds.includes(opt.campaignId));
                    
                    // 선택된 모든 캠페인의 광고그룹 불러오기
                    let allAdgroups = [];
                    
                    for (const campaignId of campaignIds) {
                        const response = await fetch(`/api/adgroups/${campaignId}`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            const adgroups = data.adgroups;
                            
                            // 캠페인 ID 추가
                            adgroups.forEach(adgroup => {
                                adgroup.campaignId = campaignId;
                            });
                            
                            allAdgroups = allAdgroups.concat(adgroups);
                        } else {
                            console.error(`캠페인 ${campaignId}의 광고그룹 정보를 불러오는데 실패했습니다.`);
                        }
                    }
                    
                    // 광고그룹 필터 옵션 초기화
                    adgroupFilterSelect.innerHTML = '';
                    
                    // 기본 옵션 추가
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '광고그룹 선택';
                    adgroupFilterSelect.appendChild(defaultOption);
                    
                    // 전체 광고그룹 옵션 추가
                    const allOption = document.createElement('option');
                    allOption.value = "";
                    allOption.textContent = '전체 광고그룹';
                    // 이전에 선택되었는지 확인
                    if (validSelectedOptions.some(opt => opt.value === "")) {
                        allOption.selected = true;
                    }
                    adgroupFilterSelect.appendChild(allOption);
                    
                    // 광고그룹 필터 옵션 추가
                    allAdgroups.forEach(adgroup => {
                        const option = document.createElement('option');
                        option.value = adgroup.nccAdgroupId;
                        option.textContent = adgroup.name || adgroup.nccAdgroupId;
                        option.dataset.campaignId = adgroup.campaignId;
                        
                        // 이전에 선택된 값이면 선택 상태로 설정
                        if (validSelectedOptions.some(opt => opt.value === adgroup.nccAdgroupId)) {
                            option.selected = true;
                        }
                        
                        adgroupFilterSelect.appendChild(option);
                    });
                    
                    // 선택된 광고그룹 항목 업데이트
                    const selectedAdgroupIds = Array.from(adgroupFilterSelect.selectedOptions)
                        .filter(option => option.value !== '')
                        .map(option => option.value);
                    
                    if (selectedAdgroupIds.length > 0) {
                        updateSelectedItems('adgroup', selectedAdgroupIds);
                        loadKeywords(selectedAdgroupIds);
                    } else {
                        // 선택된 광고그룹이 없으면 선택된 항목 초기화
                        updateSelectedItems('adgroup', []);
                        // 키워드도 초기화
                        keywordFilterSelect.innerHTML = '';
                        const defaultKeywordOption = document.createElement('option');
                        defaultKeywordOption.value = '';
                        defaultKeywordOption.textContent = '키워드 선택';
                        keywordFilterSelect.appendChild(defaultKeywordOption);
                        updateSelectedItems('keyword', []);
                    }
                } catch (error) {
                    console.error('광고그룹 정보를 불러오는데 실패했습니다:', error);
                    showErrorAlert('광고그룹 정보를 불러오는데 실패했습니다.');
                }
            }
            
            // 키워드 목록 불러오기
            async function loadKeywords(adgroupIds) {
                try {
                    if (!adgroupIds || adgroupIds.length === 0) {
                        // 광고그룹이 선택되지 않은 경우 키워드 초기화
                        keywordFilterSelect.innerHTML = '';
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = '키워드 선택';
                        keywordFilterSelect.appendChild(defaultOption);
                        
                        return;
                    }
                    
                    // 현재 선택된 키워드 ID 저장
                    const selectedOptions = Array.from(keywordFilterSelect.selectedOptions)
                        .filter(option => option.value !== '')
                        .map(option => {
                            return {
                                value: option.value,
                                text: option.textContent,
                                adgroupId: option.dataset.adgroupId
                            };
                        });
                    
                    // 선택된 광고그룹에 속하지 않는 키워드는 제외
                    const validSelectedOptions = selectedOptions.filter(opt => 
                        adgroupIds.includes(opt.adgroupId));
                    
                    // 선택된 모든 광고그룹의 키워드 불러오기
                    let allKeywords = [];
                    
                    for (const adgroupId of adgroupIds) {
                        const response = await fetch(`/api/keywords/${adgroupId}`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            const keywords = data.keywords;
                            
                            // 광고그룹 ID 추가
                            keywords.forEach(keyword => {
                                keyword.adgroupId = adgroupId;
                            });
                            
                            allKeywords = allKeywords.concat(keywords);
                        } else {
                            console.error(`광고그룹 ${adgroupId}의 키워드 정보를 불러오는데 실패했습니다.`);
                        }
                    }
                    
                    // 키워드 필터 옵션 초기화
                    keywordFilterSelect.innerHTML = '';
                    
                    // 기본 옵션 추가
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '키워드 선택';
                    keywordFilterSelect.appendChild(defaultOption);
                    
                    // 전체 키워드 옵션 추가
                    const allOption = document.createElement('option');
                    allOption.value = "";
                    allOption.textContent = '전체 키워드';
                    // 이전에 선택되었는지 확인
                    if (validSelectedOptions.some(opt => opt.value === "")) {
                        allOption.selected = true;
                    }
                    keywordFilterSelect.appendChild(allOption);
                    
                    // 키워드 필터 옵션 추가
                    allKeywords.forEach(keyword => {
                        const option = document.createElement('option');
                        option.value = keyword.nccKeywordId;
                        option.textContent = keyword.keyword || keyword.nccKeywordId;
                        option.dataset.adgroupId = keyword.adgroupId;
                        
                        // 이전에 선택된 값이면 선택 상태로 설정
                        if (validSelectedOptions.some(opt => opt.value === keyword.nccKeywordId)) {
                            option.selected = true;
                        }
                        
                        keywordFilterSelect.appendChild(option);
                    });
                    
                    // 선택된 키워드 항목 업데이트
                    const selectedKeywordIds = Array.from(keywordFilterSelect.selectedOptions)
                        .filter(option => option.value !== '')
                        .map(option => option.value);
                    
                    updateSelectedItems('keyword', selectedKeywordIds);
                } catch (error) {
                    console.error('키워드 정보를 불러오는데 실패했습니다:', error);
                    showErrorAlert('키워드 정보를 불러오는데 실패했습니다.');
                }
            }
            
            // 캠페인 선택 이벤트
            campaignFilterSelect.addEventListener('change', function(event) {
                // 선택된 캠페인 ID 배열 가져오기
                const selectedOptions = Array.from(this.selectedOptions)
                    .filter(option => option.value !== '')
                    .map(option => option.value);
                
                // 선택된 캠페인 항목 업데이트
                updateSelectedItems('campaign', selectedOptions);
                
                // 광고그룹 목록 불러오기
                loadAdgroups(selectedOptions);
            });
            
            // 광고그룹 선택 이벤트
            adgroupFilterSelect.addEventListener('change', function(event) {
                // 선택된 광고그룹 ID 배열 가져오기
                const selectedOptions = Array.from(this.selectedOptions)
                    .filter(option => option.value !== '')
                    .map(option => option.value);
                
                // 선택된 광고그룹 항목 업데이트
                updateSelectedItems('adgroup', selectedOptions);
                
                // 키워드 목록 불러오기
                loadKeywords(selectedOptions);
            });
            
            // 키워드 선택 이벤트
            keywordFilterSelect.addEventListener('change', function(event) {
                // 선택된 키워드 ID 배열 가져오기
                const selectedOptions = Array.from(this.selectedOptions)
                    .filter(option => option.value !== '')
                    .map(option => option.value);
                
                // 선택된 키워드 항목 업데이트
                updateSelectedItems('keyword', selectedOptions);
            });
            
            // 선택된 항목 업데이트 함수
            function updateSelectedItems(type, selectedIds) {
                let selectedItems;
                let tagsContainer;
                let selectedContainer;
                let selectElement;
                
                switch(type) {
                    case 'campaign':
                        selectedItems = selectedCampaignItems;
                        tagsContainer = campaignTags;
                        selectedContainer = selectedCampaigns;
                        selectElement = campaignFilterSelect;
                        break;
                    case 'adgroup':
                        selectedItems = selectedAdgroupItems;
                        tagsContainer = adgroupTags;
                        selectedContainer = selectedAdgroups;
                        selectElement = adgroupFilterSelect;
                        break;
                    case 'keyword':
                        selectedItems = selectedKeywordItems;
                        tagsContainer = keywordTags;
                        selectedContainer = selectedKeywords;
                        selectElement = keywordFilterSelect;
                        break;
                }
                
                // 선택된 항목 초기화
                selectedItems.length = 0;
                tagsContainer.innerHTML = '';
                
                // 선택된 항목 추가
                selectedIds.forEach(id => {
                    const option = Array.from(selectElement.options).find(opt => opt.value === id);
                    if (option) {
                        selectedItems.push({
                            id: id,
                            name: option.textContent
                        });
                    }
                });
                
                // 태그 생성
                selectedItems.forEach(item => {
                    const tag = document.createElement('div');
                    tag.className = 'selected-tag';
                    tag.innerHTML = `
                        ${item.name}
                        <span class="remove-tag" data-id="${item.id}" data-type="${type}">×</span>
                    `;
                    tagsContainer.appendChild(tag);
                });
                
                // 태그 표시 여부 설정
                selectedContainer.style.display = selectedItems.length > 0 ? 'block' : 'none';
                
                // 태그 삭제 이벤트
                tagsContainer.querySelectorAll('.remove-tag').forEach(tag => {
                    tag.addEventListener('click', function() {
                        const id = this.dataset.id;
                        const type = this.dataset.type;
                        
                        // 선택 해제
                        removeSelectedItem(type, id);
                    });
                });
            }
            
            // 선택된 항목 제거 함수
            function removeSelectedItem(type, id) {
                let selectElement;
                let selectedItems;
                
                switch(type) {
                    case 'campaign':
                        selectElement = campaignFilterSelect;
                        selectedItems = selectedCampaignItems;
                        break;
                    case 'adgroup':
                        selectElement = adgroupFilterSelect;
                        selectedItems = selectedAdgroupItems;
                        break;
                    case 'keyword':
                        selectElement = keywordFilterSelect;
                        selectedItems = selectedKeywordItems;
                        break;
                }
                
                // 선택 해제
                const option = Array.from(selectElement.options).find(opt => opt.value === id);
                if (option) {
                    option.selected = false;
                }
                
                // 선택된 항목 배열에서 제거
                const index = selectedItems.findIndex(item => item.id === id);
                if (index !== -1) {
                    selectedItems.splice(index, 1);
                }
                
                // 이벤트 발생
                const event = new Event('change');
                selectElement.dispatchEvent(event);
            }
            
            // 캠페인 목록 불러오기
            loadCampaigns();
            
            // 성과 차트 초기화
            let performanceChart = null;
            
            // 에러 알림 표시 함수
            function showErrorAlert(message) {
                alert(message);
            }
            
            // 리포트 생성 버튼 클릭 이벤트
            generateReportBtn.addEventListener('click', generateReport);
            
            // 리포트 생성 함수
            async function generateReport() {
                // UI 로딩 상태 표시
                generateReportBtn.disabled = true;
                generateReportBtn.textContent = '리포트 생성 중...';
                
                const dateRange = dateRangeSelect.value;
                const campaignIds = Array.from(campaignFilterSelect.selectedOptions)
                    .filter(option => option.value !== '')
                    .map(option => option.value);
                const adgroupIds = Array.from(adgroupFilterSelect.selectedOptions)
                    .filter(option => option.value !== '')
                    .map(option => option.value);
                const keywordIds = Array.from(keywordFilterSelect.selectedOptions)
                    .filter(option => option.value !== '')
                    .map(option => option.value);
                
                let datePreset = null;
                let startDateStr = startDate.value;
                let endDateStr = endDate.value;
                
                // 날짜 범위 데이터 준비
                if (dateRange !== 'custom') {
                    // 사전 정의된 기간 사용
                    switch(dateRange) {
                        case 'today':
                            datePreset = 'today';
                            break;
                        case 'yesterday':
                            datePreset = 'yesterday';
                            break;
                        case '7days':
                            datePreset = 'last7days';
                            break;
                        case '30days':
                            datePreset = 'last30days';
                            break;
                    }
                }
                
                // 기본 지표 필드 설정
                const fields = ["impCnt", "clkCnt", "ctr", "cpc", "avgRnk", "salesAmt"];
                
                // API 호출 데이터 준비
                try {
                    // 선택된 항목에 따라 entityIds 결정
                    let entityIds = [];
                    
                    if (keywordIds.length > 0) {
                        // 키워드가 선택된 경우
                        entityIds = keywordIds;
                    } else if (adgroupIds.length > 0) {
                        // 광고그룹만 선택된 경우
                        entityIds = adgroupIds;
                    } else if (campaignIds.length > 0) {
                        // 캠페인만 선택된 경우
                        entityIds = campaignIds;
                    } else {
                        // 아무것도 선택되지 않은 경우
                        showErrorAlert('캠페인, 광고그룹 또는 키워드를 선택해주세요.');
                        resetButton();
                        return;
                    }
                    
                    // ID 목록을 쉼표로 구분된 문자열로 변환
                    const entityIdStr = entityIds.join(',');
                    
                    // API 요청
                    const response = await fetch('/api/report', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            entityId: entityIdStr,  // 쉼표로 구분된 ID 문자열 전송
                            fields: fields,
                            startDate: startDateStr,
                            endDate: endDateStr,
                            datePreset: datePreset,
                            timeIncrement: "1" // 일별 데이터
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        handleReportData(data, fields);
                    } else {
                        const errorData = await response.json();
                        console.error(`리포트 생성에 실패했습니다: ${errorData.detail || '알 수 없는 오류'}`);
                        showErrorAlert(`리포트 생성에 실패했습니다: ${errorData.detail || '알 수 없는 오류'}`);
                    }
                } catch (error) {
                    console.error('리포트 생성 오류:', error);
                    showErrorAlert('리포트 생성 중 오류가 발생했습니다.');
                } finally {
                    // 버튼 상태 복원
                    resetButton();
                }
            }
            
            // 리포트 데이터 처리 함수
            function handleReportData(data, fields) {
                console.log('리포트 데이터 처리:', data);
                
                // 데이터 형식 확인
                let reportData = {
                    dates: [],
                    costs: [],
                    impressions: [],
                    clicks: [],
                    ctrs: [],
                    cpcs: [],
                    avgRanks: []
                };
                
                // 데이터 형식에 따라 처리
                if (data.dailyStatResponse && Array.isArray(data.dailyStatResponse.data)) {
                    // 일별 데이터
                    const dailyData = data.dailyStatResponse.data;
                    
                    dailyData.forEach(day => {
                        // 날짜
                        const date = day.dateStart || day.date || '';
                        reportData.dates.push(date);
                        
                        // 값 추출
                        reportData.costs.push(parseInt(day.salesAmt || 0));
                        reportData.impressions.push(parseInt(day.impCnt || 0));
                        reportData.clicks.push(parseInt(day.clkCnt || 0));
                        reportData.ctrs.push(parseFloat(day.ctr || 0));
                        reportData.cpcs.push(parseInt(day.cpc || 0));
                        reportData.avgRanks.push(parseFloat(day.avgRnk || 0));
                    });
                } else if (data.summaryStatResponse && data.summaryStatResponse.data) {
                    // 요약 데이터
                    const summary = data.summaryStatResponse.data;
                    const date = data.summaryStatResponse.timeInterval?.dateStart || new Date().toISOString().split('T')[0];
                    
                    reportData.dates.push(date);
                    reportData.costs.push(parseInt(summary.salesAmt || 0));
                    reportData.impressions.push(parseInt(summary.impCnt || a0));
                    reportData.clicks.push(parseInt(summary.clkCnt || 0));
                    reportData.ctrs.push(parseFloat(summary.ctr || 0));
                    reportData.cpcs.push(parseInt(summary.cpc || 0));
                    reportData.avgRanks.push(parseFloat(summary.avgRnk || 0));
                } else if (Array.isArray(data.data)) {
                    // 직접 데이터 배열
                    data.data.forEach(item => {
                        const date = item.dateStart || item.date || '';
                        reportData.dates.push(date);
                        
                        // 값 추출
                        reportData.costs.push(parseInt(item.salesAmt || 0));
                        reportData.impressions.push(parseInt(item.impCnt || 0));
                        reportData.clicks.push(parseInt(item.clkCnt || 0));
                        reportData.ctrs.push(parseFloat(item.ctr || 0));
                        reportData.cpcs.push(parseInt(item.cpc || 0));
                        reportData.avgRanks.push(parseFloat(item.avgRnk || 0));
                    });
                } else {
                    console.error('지원하지 않는 데이터 형식:', data);
                    showErrorAlert('지원하지 않는 데이터 형식입니다.');
                    return;
                }
                
                // 요약 통계 계산
                const totalCost = reportData.costs.reduce((a, b) => a + b, 0);
                const totalImpressions = reportData.impressions.reduce((a, b) => a + b, 0);
                const totalClicks = reportData.clicks.reduce((a, b) => a + b, 0);
                const avgCtr = totalImpressions > 0 ? (totalClicks / totalImpressions * 100).toFixed(2) : 0;
                const avgCpc = totalClicks > 0 ? (totalCost / totalClicks).toFixed(2) : 0;
                
                // 평균 노출순위 계산 - 데이터가 있는 값들의 평균
                const filteredRanks = reportData.avgRanks.filter(rank => rank > 0);
                const avgRank = filteredRanks.length > 0 
                    ? (filteredRanks.reduce((a, b) => a + b, 0) / filteredRanks.length).toFixed(1) 
                    : 0;
                
                // 요약 업데이트
                updateSummary({
                    totalCost,
                    totalImpressions,
                    totalClicks,
                    avgCtr,
                    avgCpc,
                    avgRank
                });
                
                // 차트 업데이트
                updateChart(reportData);
                
                // 테이블 업데이트
                updateTable(reportData);
            }
            
            // 요약 업데이트 함수
            function updateSummary(summaryData) {
                document.getElementById('total-cost').textContent = formatNumber(summaryData.totalCost) + '원';
                document.getElementById('total-impressions').textContent = formatNumber(summaryData.totalImpressions);
                document.getElementById('total-clicks').textContent = formatNumber(summaryData.totalClicks);
                document.getElementById('average-ctr').textContent = summaryData.avgCtr + '%';
                document.getElementById('average-cpc').textContent = formatNumber(summaryData.avgCpc) + '원';
                document.getElementById('average-rank').textContent = summaryData.avgRank;
            }
            
            // 숫자 포맷팅 함수
            function formatNumber(num) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
            
            // 차트 업데이트 함수
            function updateChart(data) {
                // 기존 차트 제거
                if (performanceChart) {
                    performanceChart.destroy();
                }
                
                const ctx = document.getElementById('performance-chart').getContext('2d');
                
                performanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: [
                            {
                                label: '노출수',
                                data: data.impressions,
                                borderColor: '#03c75a',
                                backgroundColor: 'rgba(3, 199, 90, 0.1)',
                                yAxisID: 'y',
                                tension: 0.1
                            },
                            {
                                label: '클릭수',
                                data: data.clicks,
                                borderColor: '#1a73e8',
                                backgroundColor: 'rgba(26, 115, 232, 0.1)',
                                yAxisID: 'y',
                                tension: 0.1
                            },
                            {
                                label: 'CTR (%)',
                                data: data.ctrs,
                                borderColor: '#f6b026',
                                backgroundColor: 'rgba(246, 176, 38, 0.1)',
                                yAxisID: 'y1',
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '노출수/클릭수'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'CTR (%)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            },
                        }
                    }
                });
            }
            
            // 테이블 업데이트 함수
            function updateTable(data) {
                const tableBody = document.querySelector('#report-table tbody');
                tableBody.innerHTML = '';
                
                if (data.dates.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="7" class="empty-data">데이터가 없습니다.</td>`;
                    tableBody.appendChild(row);
                    return;
                }
                
                // 각 날짜별 데이터 행 추가
                for (let i = 0; i < data.dates.length; i++) {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${data.dates[i]}</td>
                        <td>${formatNumber(data.costs[i])}원</td>
                        <td>${formatNumber(data.impressions[i])}</td>
                        <td>${formatNumber(data.clicks[i])}</td>
                        <td>${data.ctrs[i]}%</td>
                        <td>${formatNumber(data.cpcs[i])}원</td>
                        <td>${data.avgRanks[i]}</td>
                    `;
                    
                    tableBody.appendChild(row);
                }
            }
            
            // 버튼 상태 초기화 함수
            function resetButton() {
                generateReportBtn.disabled = false;
                generateReportBtn.textContent = '리포트 생성';
            }
        });
    </script>
</body>
</html> 